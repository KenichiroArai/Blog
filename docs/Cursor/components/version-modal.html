<!-- バージョン情報モーダル -->
<div class="modal fade" id="versionModal" tabindex="-1" aria-labelledby="versionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="versionModalLabel">
                    <i class="bi bi-info-circle"></i> <span id="app-title">読み込み中...</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="bi bi-tag"></i> バージョン情報
                                </h6>
                                <p class="card-text mb-2">
                                    <strong>現在のバージョン:</strong> <span id="current-version">読み込み中...</span>
                                </p>
                                <p class="card-text mb-0">
                                    <strong>開発・管理:</strong>
                                    <a id="github-link" href="#" target="_blank" rel="noopener" class="link-primary">
                                        <i class="bi bi-github"></i> <span id="github-text">読み込み中...</span>
                                    </a>
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="bi bi-graph-up"></i> 機能概要
                                </h6>
                                <ul id="features-list" class="mb-0">
                                    <li>機能情報を読み込み中...</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
                <a id="github-footer-link" href="#" target="_blank" rel="noopener" class="btn btn-primary">
                    <i class="bi bi-github"></i> GitHub で詳細を見る
                </a>
            </div>
        </div>
    </div>
</div>

<script>
/**
 * バージョンモーダルの内容を動的に更新する
 */
async function updateVersionModal() {
    console.log('🎯 === updateVersionModal関数が呼び出されました ===');

    // versionLoaderが存在しない場合は待機
    if (!window.versionLoader) {
        console.error('❌ window.versionLoaderが存在しません');
        return;
    }
    console.log('✅ window.versionLoaderが存在します');

    try {
        // バージョン情報がまだ読み込まれていない場合は読み込む
        let versionInfo = window.versionLoader.getVersionInfo();
        if (!versionInfo) {
            console.log('バージョン情報を読み込み中...');
            versionInfo = await window.versionLoader.loadVersionInfo();
        }

        console.log('取得したバージョン情報:', versionInfo);

        // versionInfoがnullの場合はデフォルト値を取得
        if (!versionInfo) {
            console.log('バージョン情報がnullのため、デフォルト値を使用します');
            versionInfo = window.versionLoader.getDefaultVersionInfo();
        }

        if (versionInfo) {
            console.log('バージョン情報が利用可能です。UI要素を更新開始...');

            // タイトルを更新
            const titleElement = document.getElementById('app-title');
            if (titleElement) {
                const title = window.versionLoader.getTitle();
                titleElement.textContent = title;
                console.log('✅ タイトルを更新:', title);
            } else {
                console.error('❌ app-title要素が見つかりません');
            }

            // バージョンを更新
            const versionElement = document.getElementById('current-version');
            if (versionElement) {
                const version = window.versionLoader.getCurrentVersion();
                versionElement.textContent = version;
                console.log('✅ バージョンを更新:', version);
            } else {
                console.error('❌ current-version要素が見つかりません');
            }

            // GitHubリンクを更新
            const githubLink = document.getElementById('github-link');
            const githubFooterLink = document.getElementById('github-footer-link');
            const githubText = document.getElementById('github-text');
            const githubUrl = window.versionLoader.getGitHubUrl();

            if (githubLink) {
                githubLink.href = githubUrl;
                console.log('✅ GitHubリンクを更新:', githubUrl);
            } else {
                console.error('❌ github-link要素が見つかりません');
            }

            if (githubFooterLink) {
                githubFooterLink.href = githubUrl;
            }

            if (githubText && versionInfo.github?.issue_number) {
                const issueText = `GitHub Issue #${versionInfo.github.issue_number}`;
                githubText.textContent = issueText;
                console.log('✅ GitHubテキストを更新:', issueText);
            } else {
                console.error('❌ github-text要素が見つからないか、issue_numberがありません');
            }

            // 機能リストを更新
            const featuresList = document.getElementById('features-list');
            if (featuresList) {
                const features = window.versionLoader.getFeatures();
                console.log('機能リスト取得:', features, 'length:', features.length);
                if (features && features.length > 0) {
                    featuresList.innerHTML = features.map(feature => `<li>${feature}</li>`).join('');
                    console.log('✅ 機能リストを更新しました');
                } else {
                    console.warn('❌ 機能リストが空または未定義です');
                    featuresList.innerHTML = '<li>機能情報が利用できません</li>';
                }
            } else {
                console.error('❌ features-list要素が見つかりません');
            }

            console.log('🎉 バージョンモーダルの更新が完了しました');
        } else {
            console.error('❌ バージョン情報の取得に失敗しました');
        }
    } catch (error) {
        console.error('バージョンモーダルの更新中にエラーが発生しました:', error);
    }
}

// モーダルが表示される際にバージョン情報を更新
function initializeVersionModal() {
    console.log('🎯 version-modal 初期化を開始');

    const versionModal = document.getElementById('versionModal');
    if (versionModal) {
        console.log('✅ バージョンモーダル要素が見つかりました');
        versionModal.addEventListener('show.bs.modal', async function() {
            console.log('🚀 バージョンモーダルが表示されます - updateVersionModal()を呼び出します');
            try {
                await updateVersionModal();
            } catch (error) {
                console.error('❌ updateVersionModal()でエラーが発生:', error);
            }
        });
    } else {
        console.error('❌ versionModal要素が見つかりません');
    }

    // バージョンローダーが利用可能になるまで待機
    async function waitForVersionLoader(attempts = 0) {
        console.log(`🔄 waitForVersionLoader 試行 ${attempts + 1}/10`);
        if (window.versionLoader) {
            console.log('✅ versionLoaderが利用可能になりました');
            try {
                await updateVersionModal();
            } catch (error) {
                console.error('❌ 初期化時のupdateVersionModal()でエラー:', error);
            }
        } else if (attempts < 10) {
            console.log(`⏳ versionLoaderを待機中... (${attempts + 1}/10)`);
            setTimeout(() => waitForVersionLoader(attempts + 1), 200);
        } else {
            console.error('❌ versionLoaderの読み込みがタイムアウトしました');
        }
    }

    // 初期化を開始
    console.log('🚀 バージョンモーダルの初期化を開始します');
    waitForVersionLoader();
}

// DOMContentLoadedが既に発生している場合は即座に実行、そうでなければイベントリスナーを追加
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeVersionModal);
} else {
    // DOM は既に読み込まれているので、即座に実行
    initializeVersionModal();
}
</script>
